# ğŸ›  Mumei Toolchain

## CLI Commands

| Command | Status | Description |
|---|---|---|
| `mumei build` | âœ… | Full pipeline: verify + codegen + transpile (reads `mumei.toml` settings) |
| `mumei verify` | âœ… | Z3 verification only |
| `mumei check` | âœ… | Parse + resolve + monomorphize (no Z3) |
| `mumei init` | âœ… | Project scaffolding with `mumei.toml` + example atoms |
| `mumei add` | âœ… | Add dependency (local path / git URL / registry name) |
| `mumei publish` | âœ… | Publish to local registry (`~/.mumei/packages/`) |
| `mumei setup` | âœ… | Download & configure Z3 + LLVM into `~/.mumei/toolchains/` |
| `mumei inspect` | âœ… | Inspect development environment (Z3, LLVM, std library, toolchains) |
| `mumei lsp` | âœ… | Language Server Protocol (hover, diagnostics) |

### Installation

```bash
# From source (requires Rust toolchain + Z3 + LLVM 18)
cargo install --path .

# Or use the setup command to install Z3/LLVM automatically
mumei setup

# Or download pre-built binary from GitHub Releases
# â†’ macOS (x86_64, aarch64), Linux (x86_64)
```

---

## Project Manifest (`mumei.toml`)

Generated by `mumei init`. All sections are automatically applied by `mumei build`.

```toml
[package]
name = "my_verified_lib"
version = "1.0.0"
authors = ["name"]
description = "A formally verified math library"

[dependencies]
# Path dependency (local)
math = { path = "./libs/math" }
# Git dependency
utils = { git = "https://github.com/user/utils-mm", tag = "v1.0.0" }
# Registry dependency (published via `mumei publish`)
crypto = "0.2.0"

[build]
targets = ["rust", "go", "typescript"]  # transpile targets
verify = true                           # enable Z3 verification
max_unroll = 3                          # BMC unroll depth

[proof]
cache = true         # incremental build cache
timeout_ms = 10000   # Z3 solver timeout
```

---

## Package Management

### Dependency Resolution Order

```
1. path dependency  â†’ local directory (direct load)
2. name dependency  â†’ ~/.mumei/registry.json â†’ ~/.mumei/packages/<name>/<version>/
3. git dependency   â†’ git clone to ~/.mumei/packages/<name>/
```

### Publishing

```bash
# Verify all atoms â†’ copy to ~/.mumei/packages/<name>/<version>/ â†’ register
mumei publish

# Publish proof cache only (no source code)
mumei publish --proof-only
```

Published package structure:
```
~/.mumei/
â”œâ”€â”€ packages/
â”‚   â””â”€â”€ my_lib/
â”‚       â””â”€â”€ 0.1.0/
â”‚           â”œâ”€â”€ mumei.toml
â”‚           â”œâ”€â”€ src/main.mm
â”‚           â””â”€â”€ .mumei_build_cache    â† proof artifact
â”œâ”€â”€ registry.json                     â† package index
â””â”€â”€ toolchains/
    â”œâ”€â”€ z3-4.13.4/
    â””â”€â”€ llvm-18.1.8/
```

### Adding Dependencies

```bash
mumei add ./libs/math                          # local path
mumei add https://github.com/user/math-mm      # git URL
mumei add math_utils                           # registry (after `mumei publish`)
```

---

## Editor Integration

### VS Code Extension

Located in `editors/vscode/`. Provides:
- `.mm` file association and syntax support
- LSP client connecting to `mumei lsp`
- Configurable server path via `mumei.serverPath` setting

```bash
cd editors/vscode
npm install
npm run compile
# Then "Run Extension" from VS Code (F5)
```

### LSP Features

| Feature | Status |
|---|---|
| `textDocument/didOpen` / `didChange` | âœ… Parse error diagnostics |
| `textDocument/hover` | âœ… Atom contract display (requires/ensures) |
| Z3 verification diagnostics | âœ… Errors shown as diagnostics |
| `textDocument/completion` | ğŸ”œ Planned |
| `textDocument/definition` | ğŸ”œ Planned |

---

## CI / Release

GitHub Actions workflow (`.github/workflows/release.yml`) triggers on `v*` tags:

1. Builds release binaries for macOS (x86_64, aarch64) and Linux (x86_64)
2. Bundles `std/` library alongside the binary
3. Creates GitHub Release with `.tar.gz` archives

---

## Environment Setup

### `mumei setup`

Downloads pre-built Z3 and LLVM 18 binaries to `~/.mumei/toolchains/`:

```bash
mumei setup            # auto-detect OS/arch
mumei setup --force    # re-download even if installed
source ~/.mumei/env    # apply environment variables
```

### `mumei inspect`

Inspects all tools with multi-path std library search (cwd â†’ exe dir â†’ `MUMEI_STD_PATH`):

```
ğŸ” Mumei Inspect: checking development environment...
  Mumei compiler: v0.2.0
  âœ… Z3: Z3 version 4.13.4
  âœ… LLVM: LLVM version 18.1.8
  âœ… Rust: rustc 1.82.0
  âœ… std library: 7/7 modules found (std)
  âœ… mumei.toml: my_project v0.1.0
  âœ… ~/.mumei/toolchains: llvm-18.1.8, z3-4.13.4
âœ… Inspect: 7 ok â€” all tools available
```

---

## Future Roadmap

- [ ] Remote package registry (central server for `mumei add <name>`)
- [ ] VS Code Marketplace publishing
- [ ] LSP completion + definition jump
- [ ] Counter-example highlighting in editors
- [ ] `mumei inspect --ai` (structured JSON output for AI agents)
- [ ] Z3 proof certificates in published packages
