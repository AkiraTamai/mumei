// =============================================================
// 検証済み小さなインタプリタ (Expression Evaluator)
// =============================================================
// Result 型を模した安全な評価器。
// 「ゼロ除算が発生しない」ことを検証付きで実装する。
// --- 精緻型 ---
type NonZero = i64 where v != 0;
// --- Enum: 演算の種類 ---
// 0 = Add, 1 = Sub, 2 = Mul, 3 = Div
enum BinOp {
    Add,
    Sub,
    Mul,
    Div
}
// --- Enum: 評価結果 ---
// 0 = Ok(value), 1 = DivByZero
enum EvalResult {
    Ok(i64),
    DivByZero
}
// =============================================================
// 安全な二項演算: ゼロ除算を検出して EvalResult で返す
// =============================================================
// op: 演算の種類 (tag 値: 0-3)
// a, b: オペランド
//
// 検証内容:
// - 全ての演算が網羅されている
// - Div の場合、b == 0 なら DivByZero (tag=1) を返す
// - それ以外は Ok (tag=0) を返す
atom safe_eval(op, a, b)
    requires: op >= 0 && op <= 3;
    ensures: result >= 0 && result <= 1;
    body: {
        match op {
            0 => 0,
            1 => 0,
            2 => 0,
            3 => if b == 0 { 1 } else { 0 },
            _ => 1
        }
    }
// =============================================================
// 安全な除算: NonZero 型で除数を制約
// =============================================================
atom safe_div(a, b: NonZero)
    requires: b != 0;
    ensures: true;
    body: a / b
